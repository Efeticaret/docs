

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Zero byte file truncate issue with Nextcloud and ownCloud deployed with FastCGI &mdash; Cyberduck Help  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="File Locking" href="Locking.html" />
    <link rel="prev" title="Known Issues" href="Issues.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #5a5a5a" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/cyberduck-icon-64.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Zero byte file truncate issue with Nextcloud and ownCloud deployed with FastCGI</a></li>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#background">Background</a><ul>
<li><a class="reference internal" href="#related-bug-reports">Related bug reports</a></li>
</ul>
</li>
<li><a class="reference internal" href="#recommended-configuration">Recommended configuration</a><ul>
<li><a class="reference internal" href="#nginx">Nginx</a></li>
<li><a class="reference internal" href="#apache">Apache</a></li>
</ul>
</li>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Cyberduck Help</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Mountain Duck</a> &raquo;</li>
        
      <li>Zero byte file truncate issue with Nextcloud and ownCloud deployed with FastCGI</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/iterate-ch/docs/edit/main/Mountain_Duck/Issues_FastCGI.md" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="tex2jax_ignore mathjax_ignore section" id="zero-byte-file-truncate-issue-with-nextcloud-and-owncloud-deployed-with-fastcgi">
<h1>Zero byte file truncate issue with Nextcloud and ownCloud deployed with FastCGI<a class="headerlink" href="#zero-byte-file-truncate-issue-with-nextcloud-and-owncloud-deployed-with-fastcgi" title="Permalink to this headline">¶</a></h1>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="summary">
<h1>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h1>
<p>Using a client to upload files with <a class="reference external" href="https://en.wikipedia.org/wiki/Chunked_transfer_encoding">HTTP chunked transfer encoding</a> to a server <strong>with fastcgi/php-fmp enabled can lead to zero byte files</strong>. Chunked transfer encoding is used when the content length is unknown at the time the transfer is started and no <code class="docutils literal notranslate"><span class="pre">Content-length</span></code> header can be set.</p>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="background">
<h1>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h1>
<p>There are basically two options to encode a <code class="docutils literal notranslate"><span class="pre">PUT</span></code> request. You either know the length of the data you want to transfer at the time of starting the request then you can set the HTTP <code class="docutils literal notranslate"><span class="pre">Content-Length</span></code> header appropriately or you don’t know the length and thus have to choose a streaming approach using the chunked transfer encoding which does not need a <code class="docutils literal notranslate"><span class="pre">Content-Length</span></code> header at all. A client is free to choose either of the two request types as both are completely fine with the <a class="reference external" href="https://tools.ietf.org/html/rfc2616">HTTP specification</a>.</p>
<p>Most clients out there, including web browsers, use the former method and thus do not hit this issue. There are use cases though which make it necessary to transfer data chunked. For example <a class="reference external" href="https://mountainduck.io/">Mountain Duck</a> that implements a virtual file system for accessing your cloud storage online. The write callbacks we get from the OS just include an offset, a buffer length and the buffer itself. Mountain Duck does not know the final size in advance. From a virtual file system perspective the call backs Mountain Duck get for an upload are as follows</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1 - CreateFile myFile.txt
2 - SetAllocationSize myFile.txt, 1024
3 - WriteFile myFile.txt, offset 0, length 1024, buffer
4 - SetAllocationSize myFile.txt, 2048
5 - WriteFile myFile.txt, offset 1024, length 1024, buffer
6 - CloseFile myFile.txt
</pre></div>
</div>
<p>In step 3 <a class="reference external" href="https://mountainduck.io/">Mountain Duck</a> opens a connection to the remote server, send a <code class="docutils literal notranslate"><span class="pre">PUT</span></code> request with the HTTP header <code class="docutils literal notranslate"><span class="pre">Transfer-Encoding:</span> <span class="pre">chunked</span></code> and streams through all subsequent write callbacks. Finally in step 6 the connection is closed.</p>
<div class="section" id="related-bug-reports">
<h2>Related bug reports<a class="headerlink" href="#related-bug-reports" title="Permalink to this headline">¶</a></h2>
<p>Since the expected length is missing in the header the streaming characteristic of such requests makes them more difficult to be handeled in the components being passed. From our research the issue only exists in environments that use Fast CGI to speak to their PHP application. See related bug reports</p>
<ul class="simple">
<li><p><a class="reference external" href="https://bugs.php.net/bug.php?id=60826">PHP Bug #60826 Raw POST data missing with chunked encoding, FastCGI</a></p></li>
<li><p><a class="reference external" href="https://bz.apache.org/bugzilla/show_bug.cgi?id=53332">Apache HTTPD bug 53332 - Requests with chunked encoding have no body available to FCGI backend</a>.</p></li>
</ul>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="recommended-configuration">
<h1>Recommended configuration<a class="headerlink" href="#recommended-configuration" title="Permalink to this headline">¶</a></h1>
<div class="section" id="nginx">
<h2>Nginx<a class="headerlink" href="#nginx" title="Permalink to this headline">¶</a></h2>
<p>The Nginx developers try to work around this issue by simply buffering the entire incoming stream and forward it through the FastCGI interface as a request with a well-known length. Make sure request buffering setting <code class="docutils literal notranslate"><span class="pre">fastcgi_request_buffering</span></code> is enabled (Nginx does request buffering by <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_request_buffering">default</a>). There are several <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html">options</a> to adjust the buffering behaviour.</p>
<p>Another (unverified) workaround might be to switch from socket to loopback communication for an Nginx/PHP-FPM setup. For more information refer to <a class="reference external" href="https://github.com/nextcloud/server/issues/3628#issuecomment-749568045">github</a>.</p>
</div>
<div class="section" id="apache">
<h2>Apache<a class="headerlink" href="#apache" title="Permalink to this headline">¶</a></h2>
<p>We are aware of migrations for Apache HTTP Server such as disabling any buffering strategies in <a class="reference external" href="https://httpd.apache.org/mod_fcgid">mod_fcgid</a> or <a class="reference external" href="https://wiki.apache.org/httpd/PHP-FPM">mod_proxy_fcgi/php-fpm</a>. Thus you should avoid using FastCGI and use <code class="docutils literal notranslate"><span class="pre">mod_php</span></code> instead which is known to handle chunked transfers correctly.</p>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="references">
<h1>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p><a class="reference external" href="http://sabre.io/dav/clients/finder/">sabre/dav - Finder</a></p></li>
<li><p><a class="reference external" href="http://sabre.io/dav/0bytes/">sabre/dav - Zero Byte Files</a></p></li>
<li><p><a class="reference external" href="https://doc.owncloud.org/server/8.1/admin_manual/issues/#troubleshooting-webdav">Troubleshooting WebDAV</a></p></li>
</ul>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="Locking.html" class="btn btn-neutral float-right" title="File Locking" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="Issues.html" class="btn btn-neutral float-left" title="Known Issues" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021 iterate GmbH.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>